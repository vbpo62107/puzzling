# 凭证管理优化执行策略

## 总体目标
- **隔离性**：为每位 Telegram 用户提供独立的 OAuth 凭证存储、加载、刷新与恢复流程，消除跨用户干扰。
- **安全性**：引入可选的静态加密防护，强化凭证在磁盘上的保密性，同时兼容现有运维方式。
- **可维护性**：建立自动化的健康巡检、日志、监控与文档体系，支撑长期稳定运营。

## 1. 定时凭证健康维护
### 1.1 调度器接入
- 在 `bot.build_application` 中利用 Telegram Bot 的 `Application.job_queue` 注册周期性维护任务，消除人工触发依赖。
- 通过环境变量（如 `TOKEN_MAINTENANCE_INTERVAL_MINUTES`、批处理大小、刷新提前量）调节执行频率，以适应不同部署规模。

### 1.2 巡检流程
- 维护任务从 `TokenStore` 获取所有已知 `user_id`，为每个用户获取文件锁，避免并发写入冲突。
- 针对每份凭证执行以下检查：
  - 确认 `user_data/` 目录下存在 `token_<user_id>.json`。
  - 判断有效期，使用 Google OAuth 的 refresh token 提前刷新。
  - 若凭证损坏或无法刷新，将其移动至 `user_data/quarantine/`，输出已脱敏的警告日志，并标记用户需重新授权。
- 记录结构化指标（处理用户数、刷新成功数、失败数等），可选地推送管理员通知。

### 1.3 韧性与测试
- 维护任务需针对单个用户的超时/异常进行隔离处理，避免整批任务中断。
- 通过集成测试（冻结时间、模拟过期）验证刷新与隔离行为，同时确保主循环保持响应。

## 2. 凭证存储与可选加密
### 2.1 加密抽象
- 新增 `security/encryption.py`，封装对称加密算法（如 AES-256-GCM 或 Fernet），密钥来自环境变量 `TOKEN_ENCRYPTION_KEY`。
- 提供 `encrypt(data: bytes)` 与 `decrypt(data: bytes)` 辅助函数，当密钥缺失时平滑降级为明文模式。

### 2.2 存取生命周期
- 在 `TokenStore._atomic_save` 以及隔离备份逻辑中，写入前先加密，再保持原子重命名与文件锁语义。
- 加载路径根据密钥情况自动解密；若检测到文件已加密但未配置密钥，应抛出明确错误提示运维介入。
- 解密失败时，将凭证隔离并提示用户重新授权，避免继续使用损坏凭证。

### 2.3 密钥治理与文档
- 在文档中说明密钥生成、存储、轮换与应急恢复流程（例如使用环境变量或密钥管理服务）。
- 提供启用加密的迁移指南，包含历史凭证的重新加密与回滚预案。
- 增补单元测试，覆盖加密开启/关闭、错误密钥、文件损坏以及并发写入等场景。

## 3. 日志脱敏与访问控制
### 3.1 掩码工具
- 实现统一的日志掩码工具（如 `security/logging_utils.mask_token_path`），对凭证路径与用户标识做不可逆脱敏处理。
- 规范日志格式，引入脱敏 ID 与结果编码，兼顾可追溯性与数据安全。

### 3.2 执行与监测
- 审查 `upload.py`、`security/token_store.py` 等模块，将直接输出路径的日志替换为掩码工具。
- 记录未授权访问、刷新失败、重复隔离等事件，并确保日志内容可执行但不含敏感信息。
- 使用 `pytest` + `caplog` 等测试工具确认各种场景下的日志均已脱敏。

## 4. 运维治理与文档体系
### 4.1 配置管理
- 通过统一配置模块集中管理调度频率、加密密钥、日志级别等参数。
- 在部署脚本、Dockerfile、CI 流程中同步更新所需环境变量的默认值与保密指引。

### 4.2 文档体系
- 在 `docs/` 目录补充运维指南，详细说明巡检任务、加密配置、日志解读与凭证缺失/损坏的排障步骤。
- 提供上线检查清单，包括：
  - 调度任务是否按计划执行。
  - 加密密钥的配置与轮换。
  - 日志是否输出脱敏信息。
  - 备份与回滚流程（关闭任务、恢复备份、重新分发密钥）。

### 4.3 测试与 CI 扩展
- 在自动化测试矩阵中引入“加密开启/关闭”双模式，验证兼容性。
- 将健康巡检相关场景纳入 CI，防止凭证处理、刷新或日志逻辑回归。

## 5. 合规与备份注意事项
- 为 `user_data/` 目录设置严格的文件系统权限，仅允许 Bot 进程访问。
- 如需备份，需排除原始凭证文件或确保备份整体加密，并记录备份/恢复步骤。
- 确认日志中不含敏感信息，同时保留授权、刷新、访问控制等审计线索。

## 6. 成功指标与验收标准
- **隔离性**：每位用户拥有独立的 `token_<user_id>.json`，跨用户访问会被拒绝并记录。
- **可用性**：巡检任务能提前刷新即将过期的凭证，避免上传过程被打断。
- **安全性**：启用密钥后凭证静态加密存储，所有日志均经过脱敏处理。
- **可观测性**：运维可通过结构化日志查看巡检结果、隔离列表，并按文档执行恢复流程。
- **测试覆盖**：自动化测试覆盖加密切换、巡检调度、异常处理与日志脱敏等核心场景。

通过上述策略，可将原有的优化方向转化为可执行步骤，构建高效、安全、可维护的凭证管理机制，实现多用户隔离、自动化健康维护、敏感数据保护与完善的运维治理闭环。
