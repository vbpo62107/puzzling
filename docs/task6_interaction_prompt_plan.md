# 任务 6：交互与提示美化执行方案

## 1. 目标重申
- 将 Bot 的所有用户交互统一为自然中文、语气友好且包含情绪化元素。
- 在上传、授权、查询等关键流程中提供可感知的实时反馈与结构化提示。
- 建立可复用的提示输出机制，保障未来功能扩展仍能维持一致的交互体验。

## 2. 实施总览
| 阶段 | 目标 | 关键产出 |
| --- | --- | --- |
| A. 现状梳理 | 收集并分类当前所有提示文本与调用位置 | 交互提示清单、分类标签 |
| B. 设计规范 | 确立提示模板、文案语气、Emoji 配置 | 《交互提示设计规范》文档、统一常量 |
| C. 能力建设 | 封装统一的提示输出 API/工具 | `message_utils` 扩展、模板渲染函数 |
| D. 模块落地 | 各业务流程全面替换旧提示逻辑 | Handlers / plugins 更新后的提示代码 |
| E. 质量校验 | 校验一致性、功能正确性与用户体验 | 测试用例、人工验收报告 |

## 3. 分阶段实施步骤

### 阶段 A：现状梳理
1. **收集提示来源**
   - 遍历 `handlers/`, `plugins/`, `message_utils.py`, `monitoring.py` 等目录。
   - 记录所有直接写入的提示文本、日志信息以及与用户交互相关的消息。
2. **分类标注**
   - 为每条提示标注类别：指令反馈、进度反馈、成功提示、错误提示、辅助提示。
   - 标注是否已包含 Emoji、是否为中文、是否符合结构（状态 + 描述 + 建议）。
3. **输出现状表**
   - 在 `docs/interaction_audit.xlsx` 或 CSV 中整理清单，为后续整改提供基准。

**验收标准**
- 清单覆盖所有与用户通信的模块（至少 `handlers/`, `plugins/`, `upload.py`, `monitoring.py`）。
- 每条记录包含模块路径、提示文本、类别、问题标签（例如 "缺少 Emoji"、"英文"）。
- 清单通过代码审查确认无遗漏。

### 阶段 B：设计规范
1. **文案与语气规则**
   - 编写《交互提示设计规范》：语气、长度、格式（最多三行）、Emoji 选用、状态层级。
   - 定义标准模板：
     - 成功：`✅ {结果描述}\n📄 文件名：{filename}\n💾 大小：{size}`
     - 错误：`❌ {问题描述}\n💡 建议：{solution}`
     - 进度：`🚀 {阶段描述}\n进度：{bar} {percent}%\n{附加信息}`
2. **Emoji 集合与文案常量**
   - 在 `message_utils.py` 中定义统一 Emoji 字典与文案片段常量（例如 `SUCCESS_HEADER`, `ERROR_FOOTER`）。
   - 建立层级枚举（一级/二级/三级），用于后续渲染时控制样式。
3. **可视化规范**
   - 设计进度条宽度、更新频率（20%-25%）、动态消息更新策略说明。

**验收标准**
- 规范文档提交至 `docs/interaction_prompt_guidelines.md`，包含语气示例与模板。
- `message_utils.py` 提供统一常量与渲染函数，覆盖成功、错误、进度、辅助四类。
- 设计规范获得产品/运营确认并归档。

### 阶段 C：能力建设
1. **模板渲染工具**
   - 在 `message_utils.py` 中新增：
     - `render_success(filename, size, link, extra=None)`
     - `render_error(reason_code, context)`（根据错误类型加载对应提示与解决方案）。
     - `render_progress(stage, percent, filename=None, eta=None)`（支持 ETA 文案、动态条）。
   - 支持传入层级枚举自动选择 Emoji。
2. **统一消息发送器**
   - 在 `handlers/` 中引入 `send_success`, `send_error`, `update_progress` 等包装函数，复用 `message_utils`。
   - 确保上传流程通过 `edit_message_text` 动态更新同一条消息。
3. **多模块适配工具**
   - 在 `monitoring.py` 或公共库中添加 `InteractionEvent` 数据结构，记录状态、消息、上下文，方便日志与提示统一处理。

**验收标准**
- 所有新增工具具备单元测试 (`tests/test_message_utils.py`, `tests/test_interaction_templates.py`) 覆盖常见参数组合。
- 上传流程能够调用 `update_progress` 动态更新进度，控制更新频率。
- 代码通过 `pytest` 与类型检查（如 `mypy` 或 `pyright`）验证。

### 阶段 D：模块落地
对以下核心流程逐一改造，确保调用统一工具：
1. **指令类处理器** (`handlers/status_handler.py`, `handlers/auth_handler.py`, `handlers/admin_handler.py`)
   - 替换 `/start`, `/help`, `/auth`, `/cancel`, `/status` 等响应文案。
   - 引入“状态 + 描述 + 建议”结构，保持语气一致。
2. **上传流程** (`handlers/upload_handler.py`, `upload.py`, `plugins/*`)
   - 统一成功提示：包含文件名、大小、访问链接。
   - 错误处理通过 `render_error` 自动生成提示与建议。
   - 进度更新统一调用 `update_progress`，按 20%-25% 刷新。
   - 对小文件上传提供“预计剩余时间很短”提示，对大文件展示 ETA。
3. **授权流程** (`handlers/auth_handler.py`, `google_utils.py`)
   - 成功授权：延迟 2 秒发送“✅ 授权成功”过渡提示。
   - 失败授权：根据错误原因提供差异化解决方案（重新扫码、网络检查等）。
4. **系统异常与后台任务** (`monitoring.py`, `cleanup_tokens.py`, `security/`)
   - 日志保持 Emoji，但确保面向用户的提示为友好中文。
   - 清理缓存时提供“🧹 正在整理缓存，请稍候”提示。

**验收标准**
- 所有用户可见提示均通过 `message_utils` 渲染函数输出。
- 提示文本经工具检查确认：100% 中文、100% 含 Emoji。
- 上传流程实际测试中展示 >=4 个进度阶段（0%、25%、50%、75%、100%）。
- 错误情况下用户能收到含原因与解决建议的提示，且建议与错误类型匹配。
- 代码审查确认无散落的硬编码文案。

### 阶段 E：质量校验
1. **自动化测试**
   - 扩充 `tests/`：
     - 模拟上传成功/失败、取消、超时等场景，断言提示文本符合规范。
     - Mock Telegram Bot API，验证消息更新次数与内容。
   - 为 `message_utils` 新增单元测试覆盖率 >90%。
2. **人工体验测试**
   - 编制用户脚本，涵盖上传不同大小文件、授权失败、命令帮助等场景。
   - 收集体验反馈，确保提示语气、节奏符合预期。
3. **一致性检查**
   - 使用脚本扫描仓库中文案，确保无英文提示、无缺失 Emoji。
   - 提交《交互一致性检查表》，列出测试结果与问题整改记录。

**验收标准**
- `pytest`、`flake8`/`ruff`、`mypy` 等检查全部通过。
- 人工测试记录中无“提示缺失/风格不符”问题。
- 一致性脚本对全仓库扫描结果为零告警。

## 4. 验收清单
- [ ] 交互提示清单（阶段 A）
- [ ] 《交互提示设计规范》与 Emoji 规则（阶段 B）
- [ ] 统一提示工具与单元测试（阶段 C）
- [ ] 各模块提示改造完成（阶段 D）
- [ ] 自动化与人工体验测试通过（阶段 E）
- [ ] 交互一致性报告归档

## 5. 后续扩展建议
1. **动态消息编辑**：使用 Telegram `edit_message_text` 实现单条消息的实时刷新，减少消息轰炸。
2. **自适应提示**：根据任务类型（小文件/大文件/离线任务）动态调整语气、ETA 提示与刷新频率。
3. **错误语义库**：维护错误码与提示语映射表，未来扩展多语言只需新增翻译。
4. **多语言能力**：预留 i18n 支持，在 `message_utils` 中引入语言参数或翻译字典。
5. **可观测性联动**：将交互事件同步写入监控系统，支持统计提示使用频率与用户响应行为。

---
通过以上执行策略，Task 6 的交互与提示美化不仅实现视觉与文案升级，更建立了结构化、可维护的交互机制，支撑后续功能扩展与体验迭代。
